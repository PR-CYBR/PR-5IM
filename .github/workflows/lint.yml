name: Lint

on:
  push:
    branches: [main, dev, impl, spec, plan]
  pull_request:
    branches: [main, dev, impl]
  workflow_dispatch:

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install markdownlint-cli2
        run: npm install -g markdownlint-cli2
        
      - name: Run markdownlint
        run: markdownlint-cli2 "**/*.md" "#node_modules" "#.venv" "#venv"

  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install yamllint
        run: pip install yamllint
        
      - name: Run yamllint
        run: |
          yamllint -d "{extends: default, rules: {line-length: {max: 120}, document-start: disable, comments: {min-spaces-from-content: 1}}}" \
            configs/ workflows/ .github/workflows/ || echo "YAML linting completed with warnings"

  python-lint:
    name: Python Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black pylint isort
          
      - name: Check for Python files
        id: check_python
        run: |
          if find src -name "*.py" -not -path "*/venv/*" -not -path "*/.venv/*" | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Run flake8
        if: steps.check_python.outputs.has_python == 'true'
        run: |
          flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,.venv
          flake8 src --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv,.venv
          
      - name: Run black
        if: steps.check_python.outputs.has_python == 'true'
        run: |
          black --check --diff src --exclude='(venv|\.venv)'
          
      - name: Run isort
        if: steps.check_python.outputs.has_python == 'true'
        run: |
          isort --check-only --diff src --skip venv --skip .venv
          
      - name: Run pylint
        if: steps.check_python.outputs.has_python == 'true'
        continue-on-error: true
        run: |
          pylint src --exit-zero --ignore=venv,.venv

  link-check:
    name: Link Checking
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Link Checker
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress '**/*.md' '**/*.html' --exclude-path './node_modules/**' --exclude-path './venv/**' --exclude-path './.venv/**'
          fail: false

  status:
    name: Lint Status
    runs-on: ubuntu-latest
    needs: [markdown-lint, yaml-lint, python-lint, link-check]
    if: always()
    steps:
      - name: Check lint status
        run: |
          if [ "${{ needs.markdown-lint.result }}" != "success" ] || \
             [ "${{ needs.yaml-lint.result }}" != "success" ] || \
             [ "${{ needs.python-lint.result }}" != "success" ]; then
            echo "Linting checks failed"
            exit 1
          fi
          echo "All linting checks passed"
